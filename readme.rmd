---
output:
  md_document:
    variant: gfm
---

# Entropy Balancing in High Dimensions

**Apoorva Lal**

Minimal working example of Double-LASSO augmented entropy balancing estimator
proposed in Lal (2021).

```{r}
rm(list = ls())
library(LalRUtils)
set.seed(42)
# paths
source("/home/alal/Desktop/code/00_causal/KnockoffEntropyBalancing/estimators.R")
```

## PSID experimental benchmark

```{r}
data(lalonde.exp)
summary(robustify(felm(re78 ~ treat, lalonde.exp)))$coefficients[2, 1:2]
```

## Implementation on PSID Lalonde Sample

Estimation akin to Dehejia & Wahba (1999).

### Traditional Estimators

```{r}
data(lalonde.psid)
dtpsid = data.table(lalonde.psid)
y = 're78'; w =  'treat'
x = setdiff(colnames(lalonde.psid), c(y, w))

# %% traditional estimators
dm_est  = diffmeans(dtpsid, y, w)
cov_est = covaradjust(dtpsid, y, w, x)
ipw_est = ipw_reg(dtpsid, y, w, x)
eb_est = eb_reg(dtpsid, y, w, x)
lr_est = rbind(dm_est, cov_est, ipw_est, eb_est)
rownames(lr_est) = c('difference in means', 'regression', 'ipw', 'entropy balancing')
lr_est
```

### Double LASSO and Knockoff EB

```{r}
y = 're78'
w =  'treat'
x = setdiff(colnames(lalonde.psid), c(y, w))
# %% basis expansion and interaction creation step
data = prep_matrices('re78', 'treat', controls = x, dat = dtpsid)
y = data[[1]]
w = data[[2]]
X = data[[3]]

# %% estimation using double lasso, and knockoff lasso + knockoff-ebal
hdres = estimate_hdc(y, w, X)
```

## final estimates

```{r}
rbind(lr_est, hdres)
```

Knockoff-EB comes closest to the experimental benchmark. All the regression
estimators (and IPW) estimate the wrong sign.
